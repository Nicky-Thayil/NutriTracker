{% extends "base.html" %}

{% block title %}Weight Tracker - NutriTracker{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="display-6">
                <i class="bi bi-graph-up text-primary"></i> Weight Tracker
            </h1>
            <p class="text-muted">Monitor your weight progress over time</p>
        </div>
        <div class="col-md-4 text-md-end">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addWeightModal">
                <i class="bi bi-plus-circle"></i> Add Weight
            </button>
        </div>
    </div>

    <!-- Current Stats -->
    {% if weight_30d.latest_weight %}
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body">
                    <i class="bi bi-speedometer text-primary mb-2" style="font-size: 2rem;"></i>
                    <h3 class="card-title">{{ weight_30d.latest_weight }} kg</h3>
                    <p class="card-text text-muted">Current Weight</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body">
                    <i class="bi bi-calendar-week text-info mb-2" style="font-size: 2rem;"></i>
                    <h3 class="card-title">{{ weight_7d.change }} kg</h3>
                    <p class="card-text text-muted">7-Day Change</p>
                    <span class="badge bg-{{ 'success' if weight_7d.change <= 0 else 'warning' }}">
                        {{ weight_7d.trend|replace('_', ' ')|title }}
                    </span>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body">
                    <i class="bi bi-calendar-month text-warning mb-2" style="font-size: 2rem;"></i>
                    <h3 class="card-title">{{ weight_30d.change }} kg</h3>
                    <p class="card-text text-muted">30-Day Change</p>
                    <span class="badge bg-{{ 'success' if weight_30d.change <= 0 else 'warning' }}">
                        {{ weight_30d.trend|replace('_', ' ')|title }}
                    </span>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body">
                    <i class="bi bi-calendar3 text-danger mb-2" style="font-size: 2rem;"></i>
                    <h3 class="card-title">{{ weight_90d.change }} kg</h3>
                    <p class="card-text text-muted">90-Day Change</p>
                    <span class="badge bg-{{ 'success' if weight_90d.change <= 0 else 'warning' }}">
                        {{ weight_90d.trend|replace('_', ' ')|title }}
                    </span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row">
        <!-- Weight Chart -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-graph-up"></i> Weight Progress
                    </h5>
                </div>
                <div class="card-body">
                    <div class="btn-group mb-3" role="group">
                        <input type="radio" class="btn-check" name="timeRange" id="range7d" value="7d" checked>
                        <label class="btn btn-outline-primary" for="range7d">7 Days</label>

                        <input type="radio" class="btn-check" name="timeRange" id="range30d" value="30d">
                        <label class="btn btn-outline-primary" for="range30d">30 Days</label>

                        <input type="radio" class="btn-check" name="timeRange" id="range90d" value="90d">
                        <label class="btn btn-outline-primary" for="range90d">90 Days</label>
                    </div>
                    
                    <canvas id="weightChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Weight Log & Stats -->
        <div class="col-lg-4">
            <!-- Recent Entries -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history"></i> Recent Entries
                    </h5>
                </div>
                <div class="card-body">
                    {% if weight_30d.entries %}
                        {% for entry in weight_30d.entries[-5:] %}
                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                            <div>
                                <div class="fw-bold">{{ entry.weight }} kg</div>
                                <small class="text-muted">{{ entry.date }}</small>
                            </div>
                            {% if not loop.last %}
                            <div class="text-end">
                                {% set prev_weight = weight_30d.entries[loop.index0 + 1].weight if loop.index0 + 1 < weight_30d.entries|length else entry.weight %}
                                {% set change = entry.weight - prev_weight %}
                                {% if change != 0 %}
                                <small class="badge bg-{{ 'success' if change < 0 else 'warning' }}">
                                    {{ '+' if change > 0 else '' }}{{ "%.1f"|format(change) }}
                                </small>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center py-4">
                            <i class="bi bi-plus-circle"></i><br>
                            No weight entries yet.<br>
                            <button type="button" class="btn btn-sm btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#addWeightModal">
                                Add First Entry
                            </button>
                        </p>
                    {% endif %}
                </div>
            </div>

            <!-- BMI Calculator -->
            {% if current_user.height %}
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-calculator"></i> BMI
                    </h5>
                </div>
                <div class="card-body text-center">
                    {% if weight_30d.latest_weight %}
                        {% set bmi = (weight_30d.latest_weight / ((current_user.height / 100) ** 2))|round(1) %}
                        <h3 class="text-primary">{{ bmi }}</h3>
                        <p class="mb-2">
                            {% if bmi < 18.5 %}
                                <span class="badge bg-info">Underweight</span>
                            {% elif bmi < 25 %}
                                <span class="badge bg-success">Normal</span>
                            {% elif bmi < 30 %}
                                <span class="badge bg-warning">Overweight</span>
                            {% else %}
                                <span class="badge bg-danger">Obese</span>
                            {% endif %}
                        </p>
                        <small class="text-muted">Based on height: {{ current_user.height }} cm</small>
                    {% else %}
                        <p class="text-muted">Add a weight entry to calculate BMI</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Weight Modal -->
<div class="modal fade" id="addWeightModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Weight Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_weight') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="weight" class="form-label">Weight (kg)</label>
                        <input type="number" class="form-control" id="weight" name="weight" step="0.1" required>
                    </div>
                    <div class="mb-3">
                        <label for="entry_date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="entry_date" name="entry_date" value="{{ date.today() }}" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Weight</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Weight chart data
const weightData = {
    '7d': {{ weight_7d.entries|tojson }},
    '30d': {{ weight_30d.entries|tojson }},
    '90d': {{ weight_90d.entries|tojson }}
};

let weightChart;

function initWeightChart() {
    const ctx = document.getElementById('weightChart').getContext('2d');
    weightChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Weight (kg)',
                data: [],
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: 'Weight (kg)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Date'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    updateChart('7d');
}

function updateChart(range) {
    const data = weightData[range];
    if (data && data.length > 0) {
        weightChart.data.labels = data.map(entry => entry.date);
        weightChart.data.datasets[0].data = data.map(entry => entry.weight);
        weightChart.update();
    }
}

// Event listeners for time range buttons
document.querySelectorAll('input[name="timeRange"]').forEach(radio => {
    radio.addEventListener('change', function() {
        updateChart(this.value);
    });
});

// Initialize chart when page loads
document.addEventListener('DOMContentLoaded', initWeightChart);
</script>
{% endblock %}
